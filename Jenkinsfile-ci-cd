pipeline {
  agent { label 'slave01' }

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '5'))
    timeout(time: 10, unit: 'MINUTES')
  }

  environment {
    REPO_URL              = 'https://github.com/devopsit-mg/jenkins-training.git'
    GITHUB_CREDENTIALS_ID = 'access-token-jenkins-patryk-ostrzycki'
    BASE_DIR              = 'app-test'
    APP_DIR               = "${BASE_DIR}/app"
    DOCKERFILE_PATH       = "${BASE_DIR}/Dockerfile"
    REGISTRY_URL         = 'https://index.docker.io/v1/'
    IMAGE_REPO           = 'ghcr.io/patrykostrzyckicoi/app-test'
    REGISTRY_CREDENTIALS = 'access-token-jenkins-patryk-ostrzycki'
  }

  stages {
    stage('Checkout') {
      steps {
        git url: env.REPO_URL, branch: 'main',
            changelog: true, poll: true,
            credentialsId: env.GITHUB_CREDENTIALS_ID
        sh 'git --version'
      }
    }

    stage('Test (pytest)') {
      steps {
        dir(env.APP_DIR) {
          sh '''
            set -eux
            python3 -V
            pip3 -V || true
            python3 -m pip install --upgrade pip
            python3 -m pip install -r requirements.txt
            # uruchom tests i wypisz junit do reports/
            mkdir -p reports
            python3 -m pytest -q --junitxml=reports/junit.xml
          '''
          junit 'reports/junit.xml'
        }
      }
    }

    stage('Build Docker image') {
      environment {
        GIT_SHA = ''
      }
      steps {
        script {
          GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
          env.GIT_SHA = GIT_SHA
          env.IMAGE_TAG = "${IMAGE_REPO}:${GIT_SHA}"
          env.IMAGE_LATEST = "${IMAGE_REPO}:latest"
        }
        sh '''
          set -eux
          docker build \
            -f "${DOCKERFILE_PATH}" \
            -t "${IMAGE_TAG}" \
            -t "${IMAGE_LATEST}" \
            "${BASE_DIR}"
        '''
      }
    }

    stage('Push image') {
      steps {
        withCredentials([usernamePassword(credentialsId: env.REGISTRY_CREDENTIALS,
                                          usernameVariable: 'REG_USER',
                                          passwordVariable: 'REG_PASS')]) {
          sh '''
            set -eux
            echo "$REG_PASS" | docker login "${REGISTRY_URL}" -u "$REG_USER" --password-stdin
            docker push "${IMAGE_TAG}"
            docker push "${IMAGE_LATEST}"
            docker logout "${REGISTRY_URL}"
          '''
        }
      }
    }

    stage('Deploy & smoke-test') {
      steps {
        script {
          def rnd = new Random()
          env.APP_PORT = (10000 + rnd.nextInt(10000)).toString()
        }
        sh '''
          set -eux
          CID=$(docker run -d -p "${APP_PORT}:5000" "${IMAGE_TAG}")
          # Daj chwilę na start
          for i in $(seq 1 20); do
            if curl -fsS "http://localhost:${APP_PORT}/health" >/dev/null 2>&1; then break; fi
            sleep 1
          done
          # Sprawdź dokładną odpowiedź
          RESP=$(curl -fsS "http://localhost:${APP_PORT}/health")
          echo "Health response: $RESP"
          test "$RESP" = '{"status":"ok"}' || test "$RESP" = '{"status": "ok"}'
          docker rm -f "$CID"
        '''
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
